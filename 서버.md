# 온시아 CRM 배포 및 보안 가이드

## 📊 현재 상황 진단

**⚠️ 치명적 문제:** 현재 사용 중인 **SQLite는 Vercel에서 작동하지 않습니다**

- Vercel은 서버리스 환경 → 파일 시스템이 임시적/읽기 전용
- 배포 시 **PostgreSQL/MySQL로 반드시 전환 필요**

---

## 🎯 추천 배포 전략

### 최적 조합: Vercel + Supabase

#### 1단계: 무료로 시작 ($0/월)

**Vercel Hobby 플랜 (무료)**
- 자동 배포/롤백
- HTTPS 자동 적용
- DDoS 기본 방어
- 글로벌 CDN
- 직원 10-20명 충분

**Supabase 무료 티어**
- PostgreSQL 500MB (고객 수천 건 가능)
- 자동 백업
- 실시간 기능
- SSL 연결

**Upstash Redis 무료 티어**
- Rate Limiting용

#### 2단계: 트래픽 증가 시 업그레이드 ($55/월)

- **Vercel Pro** ($20/월): 더 빠른 속도, DDoS 고급 방어, 팀 협업 기능
- **Supabase Pro** ($25/월): 8GB DB, 일일 자동 백업, 우선 기술 지원
- **Upstash Pro** ($10/월)

---

## 🛡️ 보안 대책 (필수 구현 사항)

### 1. Rate Limiting (요청 횟수 제한)

무차별 대입 공격 방어:
- 로그인: IP당 5회/분
- API 요청: 사용자당 100회/분
- 파일 업로드: 10회/시간

### 2. 환경 변수 보안

```bash
# Vercel 환경 변수에만 저장 (절대 GitHub에 푸시 X)
DATABASE_URL=postgresql://...
AUTH_SECRET=랜덤32자이상
NEXTAUTH_URL=https://your-domain.com
```

### 3. 데이터베이스 접근 제어

- ✅ SSL 필수 연결
- ✅ IP 화이트리스트 (Vercel IP만 허용)
- ✅ 강력한 DB 비밀번호 (20자 이상)

### 4. 네트워크 보안

- ✅ Vercel 자동 DDoS 방어
- ✅ 해외 IP 차단 가능 (한국만 허용)
- ✅ HTTPS 강제

### 5. 개인정보 보호

- 전화번호 마스킹: `010-****-5678`
- 데이터 암호화:
  - 전송 중: TLS 1.3
  - 저장 시: PostgreSQL 암호화

### 6. 모니터링 (이미 구현됨!)

AuditLog 테이블 활용:
- 모든 로그인 기록
- 고객 생성/수정/삭제 추적
- 의심 활동 감지:
  - 짧은 시간 내 다수 로그인 실패
  - 비정상적 대량 데이터 접근
  - 관리자 권한 변경 시도

---

## 🚀 배포 프로세스 (5-7일 소요)

### Phase 1: 준비 (2-3일)

1. **Supabase 계정 생성 및 프로젝트 생성**
   - https://supabase.com 회원가입
   - New Project 생성
   - DATABASE_URL 복사

2. **코드 수정**
   ```prisma
   // prisma/schema.prisma
   datasource db {
     provider = "postgresql"  // "sqlite"에서 변경
     url      = env("DATABASE_URL")
   }
   ```

3. **마이그레이션 실행**
   ```bash
   npx prisma migrate dev
   npx prisma db seed
   ```

### Phase 2: 보안 강화 (1-2일)

1. **Rate Limiting 구현**
   ```bash
   npm install @upstash/ratelimit @upstash/redis
   ```

2. **보안 헤더 추가**
   ```javascript
   // next.config.js
   async headers() {
     return [
       {
         source: '/:path*',
         headers: [
           {
             key: 'X-Frame-Options',
             value: 'DENY'
           },
           {
             key: 'X-Content-Type-Options',
             value: 'nosniff'
           },
           {
             key: 'Content-Security-Policy',
             value: "default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline';"
           }
         ]
       }
     ]
   }
   ```

### Phase 3: Vercel 배포 (1일)

1. **Vercel 계정 생성**
   - https://vercel.com 회원가입
   - GitHub 계정 연결

2. **프로젝트 임포트**
   - New Project → Import GitHub Repository
   - `onsia_CRM` 저장소 선택

3. **환경 변수 입력** (Vercel 대시보드)
   ```
   DATABASE_URL=postgresql://[Supabase URL]
   AUTH_SECRET=[openssl rand -base64 32로 생성]
   NEXTAUTH_URL=https://your-app.vercel.app
   ```

4. **배포 및 테스트**
   - Deploy 버튼 클릭
   - 빌드 완료 후 URL 확인
   - 전체 기능 테스트

### Phase 4: 모니터링 (1일)

1. **Vercel Analytics 활성화**
   - Vercel 대시보드 → Analytics 탭

2. **Sentry 에러 추적** (선택사항)
   - https://sentry.io 회원가입
   - Next.js 연동

3. **데이터베이스 백업 확인**
   - Supabase 대시보드 → Backups 확인

---

## ⚠️ 보안 위협 대응

### 시나리오 1: 무차별 로그인 시도

- **공격:** 비밀번호 무차별 대입
- **방어:** Rate Limiting (5회 실패 → 15분 차단)
- **모니터링:** AuditLog에서 실패 패턴 감지

### 시나리오 2: 데이터베이스 직접 접근

- **공격:** DB 직접 접속 시도
- **방어:** IP 화이트리스트 (Vercel만 허용)
- **추가:** 강력한 DB 비밀번호, 정기 변경

### 시나리오 3: 내부자 위협

- **위험:** 직원의 데이터 유출
- **방어:** 역할 기반 권한 (RBAC)
- **모니터링:** 대량 다운로드, 비정상 시간 접속 감지

### 시나리오 4: DDoS 공격

- **공격:** 서비스 마비 시도
- **방어:** Vercel 자동 DDoS 방어
- **추가:** Rate Limiting으로 과도한 요청 차단

---

## 💰 비용 비교

| 시나리오 | 월 비용 | 적합한 경우 |
|---------|--------|-----------|
| **무료 시작** | $0 | 직원 10-20명, 고객 수천 건 |
| **안정적 운영** (추천) | $55 | 직원 50명+, 고객 만 건+ |
| **엔터프라이즈** | $200+ | 직원 100명+, 고객 10만+ |

**권장:** 무료로 시작 → 트래픽 증가 시 업그레이드

---

## 🔧 대안 배포 방식

### 1. 자체 서버 (VPS)

- **비용:** $5-20/월
- **장점:** SQLite 사용 가능, 완전한 제어
- **단점:** 서버 관리 부담, 보안 직접 구축, 24시간 모니터링
- **추천:** ❌ 서버 관리 경험 없으면 비추천

### 2. Railway / Render

- **비용:** $5-10/월
- **장점:** PostgreSQL 포함, 저렴함
- **단점:** Vercel보다 느림
- **추천:** △ 비용 절감이 최우선인 경우

### 3. Vercel + Supabase ⭐ (추천)

- **비용:** $0-55/월
- **장점:** 자동화, 확장성, 관리 용이
- **단점:** PostgreSQL 별도 필요
- **추천:** ✅ 대부분의 경우 최선

---

## 📋 배포 전 체크리스트

- [ ] SQLite → PostgreSQL 마이그레이션 완료
- [ ] 환경 변수 Vercel에 안전하게 설정
- [ ] Rate Limiting 구현
- [ ] 보안 헤더 추가
- [ ] 전체 기능 테스트 (로그인, 고객 등록, 엑셀 업로드)
- [ ] 데이터베이스 백업 설정
- [ ] 모니터링 도구 연동
- [ ] 직원 계정 생성 및 권한 설정
- [ ] 관리자 승인 시스템 테스트
- [ ] 백업 복원 절차 테스트

---

## 🎓 직원 보안 교육 (필수)

1. 강력한 비밀번호 사용 (12자 이상, 특수문자 포함)
2. 비밀번호 재사용 금지
3. 피싱 이메일 주의
4. 공용 컴퓨터 사용 후 로그아웃
5. 업무 외 시간 접속 최소화
6. 의심스러운 활동 즉시 보고

---

## 🔐 환경 변수 생성 가이드

### AUTH_SECRET 생성

```bash
# Mac/Linux
openssl rand -base64 32

# Windows (PowerShell)
[Convert]::ToBase64String((1..32 | ForEach-Object { Get-Random -Minimum 0 -Maximum 256 }))
```

### DATABASE_URL 형식

```
postgresql://[username]:[password]@[host]:[port]/[database]?schema=public
```

Supabase에서 자동 생성된 URL을 그대로 사용하면 됩니다.

---

## 📞 문제 발생 시 대응

### 배포 실패

1. Vercel 로그 확인 (Deployments → View Logs)
2. 환경 변수 정확히 입력되었는지 확인
3. `npx prisma generate` 실행 후 재배포

### 데이터베이스 연결 실패

1. DATABASE_URL이 정확한지 확인
2. Supabase 프로젝트가 활성 상태인지 확인
3. IP 화이트리스트 설정 확인

### 로그인 안 됨

1. AUTH_SECRET이 설정되었는지 확인
2. NEXTAUTH_URL이 실제 배포 URL과 일치하는지 확인
3. 쿠키 설정 확인 (Secure, SameSite)

---

## 📚 추가 참고 자료

- [Vercel 공식 문서](https://vercel.com/docs)
- [Supabase 공식 문서](https://supabase.com/docs)
- [NextAuth.js 문서](https://next-auth.js.org/)
- [Prisma 문서](https://www.prisma.io/docs)

---

**마지막 업데이트:** 2025-10-08
**작성자:** Claude Code
**프로젝트:** 온시아 CRM
