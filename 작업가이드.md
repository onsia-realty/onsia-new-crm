
# 온시아 고객관리카드 시스템 구현 작업 가이드

## ✅ 완료된 작업 (2025-01-08)

### 1. DB 스키마 수정 완료
- ✅ Customer 모델에 개인정보 필드 추가 (gender, ageRange, residenceArea, familyRelation, occupation)
- ✅ Customer 모델에 영업정보 필드 추가 (source, investmentStyle, expectedBudget, ownedProperties, recentVisitedMH)
- ✅ Enum 타입 정의 (Gender, AgeRange, CustomerSource)
- ✅ CallLog 모델 간소화 (content, note만 남김)
- ✅ CallType enum 제거

---

## 🔄 지금부터 해야 할 작업

### Phase 1: 데이터베이스 마이그레이션 (10분)

#### 1.1 개발 서버 모두 종료
```bash
# 실행 중인 모든 npm 프로세스 종료
taskkill /F /IM node.exe

# 또는 Ctrl+C로 모든 터미널 종료
```

#### 1.2 Prisma Client 재생성
```bash
npx prisma generate
```

**에러 발생 시:**
```bash
# node_modules 캐시 정리
rm -rf node_modules/.prisma
rm -rf node_modules/@prisma

# 다시 생성
npx prisma generate
```

#### 1.3 마이그레이션 생성 및 실행
```bash
# 마이그레이션 파일 생성
npx prisma migrate dev --name add_customer_management_card_fields

# 프롬프트에서 "Yes" 선택
```

**중요:** 이 명령은 기존 데이터를 보존합니다! (새 필드는 모두 nullable)

#### 1.4 마이그레이션 확인
```bash
# DB 확인
npx prisma studio

# 브라우저에서 http://localhost:5555 열림
# Customer 테이블에 새 필드들이 추가되었는지 확인
# 기존 50건 데이터가 그대로 있는지 확인
```

---

### Phase 2: Validation 스키마 업데이트 (20분)

#### 2.1 Customer Validation 수정

**파일: `lib/validations/customer.ts`**

```typescript
import { z } from 'zod'

// 기존 스키마에 추가
export const createCustomerSchema = z.object({
  name: z.string().min(2, '이름은 2자 이상이어야 합니다'),
  phone: z.string().regex(
    /^(0[0-9]{1,2}|1[0-9]{3})[0-9]{6,8}$/,
    '유효한 전화번호를 입력해주세요'
  ),
  email: z.string().email('유효한 이메일을 입력해주세요').optional().or(z.literal('')),
  address: z.string().optional(),
  memo: z.string().optional(),

  // 개인 정보 (새로 추가)
  gender: z.enum(['MALE', 'FEMALE']).optional(),
  ageRange: z.enum(['TWENTIES', 'THIRTIES', 'FORTIES', 'FIFTIES', 'SIXTIES_PLUS']).optional(),
  residenceArea: z.string().optional(),
  familyRelation: z.string().optional(),
  occupation: z.string().optional(),

  // 영업 정보 (새로 추가)
  source: z.enum(['AD', 'TM', 'FIELD', 'REFERRAL']).optional(),
  investmentStyle: z.string().optional(), // JSON string
  expectedBudget: z.number().int().positive().optional(),
  ownedProperties: z.string().optional(), // JSON string
  recentVisitedMH: z.string().optional(),

  assignedUserId: z.string().optional(),
})

export const updateCustomerSchema = createCustomerSchema.partial()

export type CreateCustomerInput = z.infer<typeof createCustomerSchema>
export type UpdateCustomerInput = z.infer<typeof updateCustomerSchema>
```

#### 2.2 CallLog Validation 생성

**파일: `lib/validations/call-log.ts` (새 파일)**

```typescript
import { z } from 'zod'

export const createCallLogSchema = z.object({
  customerId: z.string(),
  content: z.string().min(1, '통화 내용을 입력해주세요'),
  note: z.string().optional(),
})

export const updateCallLogSchema = createCallLogSchema.partial()

export type CreateCallLogInput = z.infer<typeof createCallLogSchema>
export type UpdateCallLogInput = z.infer<typeof updateCallLogSchema>
```

---

### Phase 3: API 라우트 업데이트 (30분)

#### 3.1 CallLog API 수정

**파일: `app/api/call-logs/route.ts`**

기존 파일을 찾아서 수정:
```typescript
// 기존 import 수정
import { createCallLogSchema } from '@/lib/validations/call-log'

// POST 핸들러의 body validation 부분 수정
const validatedData = createCallLogSchema.parse(body)

// Prisma create 부분 수정
await prisma.callLog.create({
  data: {
    customerId: validatedData.customerId,
    userId: session.user.id,
    content: validatedData.content,
    note: validatedData.note || null,
  },
})
```

#### 3.2 Customer API - 새 필드 처리 확인

**파일: `app/api/customers/route.ts`**

이미 `createCustomerSchema`를 사용하고 있으므로 자동으로 새 필드가 처리됩니다.
추가 수정 필요 없음!

#### 3.3 Customer Detail API - include 확인

**파일: `app/api/customers/[id]/route.ts`**

이미 수정되어 있으므로 추가 작업 없음!

---

### Phase 4: UI 재설계 (1-1.5시간)

#### 4.1 고객 등록/수정 폼 컴포넌트

**파일: `app/dashboard/customers/new/page.tsx` (또는 유사한 파일)**

찾아서 다음 필드 추가:

```typescript
// 성별
<Select name="gender">
  <SelectTrigger>
    <SelectValue placeholder="성별 선택" />
  </SelectTrigger>
  <SelectContent>
    <SelectItem value="MALE">남</SelectItem>
    <SelectItem value="FEMALE">여</SelectItem>
  </SelectContent>
</Select>

// 나이대
<Select name="ageRange">
  <SelectTrigger>
    <SelectValue placeholder="나이대 선택" />
  </SelectTrigger>
  <SelectContent>
    <SelectItem value="TWENTIES">20대</SelectItem>
    <SelectItem value="THIRTIES">30대</SelectItem>
    <SelectItem value="FORTIES">40대</SelectItem>
    <SelectItem value="FIFTIES">50대</SelectItem>
    <SelectItem value="SIXTIES_PLUS">60대 이상</SelectItem>
  </SelectContent>
</Select>

// 거주지역
<Input name="residenceArea" placeholder="거주지역" />

// 가족관계
<Input name="familyRelation" placeholder="가족관계" />

// 직업
<Input name="occupation" placeholder="직업" />

// 분류 (광고/TM/필드/소개)
<Select name="source">
  <SelectTrigger>
    <SelectValue placeholder="분류 선택" />
  </SelectTrigger>
  <SelectContent>
    <SelectItem value="AD">광고</SelectItem>
    <SelectItem value="TM">TM</SelectItem>
    <SelectItem value="FIELD">필드</SelectItem>
    <SelectItem value="REFERRAL">소개</SelectItem>
  </SelectContent>
</Select>

// 투자성향 (체크박스)
<div className="space-y-2">
  <Label>투자성향</Label>
  <div className="flex gap-4">
    <label className="flex items-center gap-2">
      <input type="checkbox" name="investmentStyle.timeProfit" />
      <span>시세차익</span>
    </label>
    <label className="flex items-center gap-2">
      <input type="checkbox" name="investmentStyle.monthlyIncome" />
      <span>월수익</span>
    </label>
    <label className="flex items-center gap-2">
      <input type="checkbox" name="investmentStyle.residence" />
      <span>실거주</span>
    </label>
  </div>
</div>

// 예상투자금액
<Input
  name="expectedBudget"
  type="number"
  placeholder="예상투자금액 (만원 단위, 계약금 기준)"
/>

// 보유현황 (체크박스)
<div className="space-y-2">
  <Label>보유현황</Label>
  <div className="flex gap-4">
    <label className="flex items-center gap-2">
      <input type="checkbox" name="ownedProperties.apt" />
      <span>APT</span>
    </label>
    <label className="flex items-center gap-2">
      <input type="checkbox" name="ownedProperties.officetel" />
      <span>오피스텔</span>
    </label>
    <label className="flex items-center gap-2">
      <input type="checkbox" name="ownedProperties.commercial" />
      <span>상가</span>
    </label>
    <label className="flex items-center gap-2">
      <input type="checkbox" name="ownedProperties.building" />
      <span>건물</span>
    </label>
  </div>
</div>

// 최근 방문 모델하우스
<Input name="recentVisitedMH" placeholder="최근 방문 모델하우스" />
```

#### 4.2 고객 상세 페이지 수정

**파일: `app/dashboard/customers/[id]/page.tsx`**

기존 통화기록 부분 찾아서 수정:

```typescript
// 통화 기록 추가 폼 (기존 복잡한 것을 간단하게 교체)
const [newCallLog, setNewCallLog] = useState({
  content: '',
  note: ''
})

// 통화 기록 추가 함수
const handleAddCallLog = async () => {
  try {
    const response = await fetch('/api/call-logs', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        customerId: params.id,
        content: newCallLog.content,
        note: newCallLog.note
      })
    })

    if (response.ok) {
      await fetchCustomerData()
      setNewCallLog({ content: '', note: '' })
      toast({ title: '성공', description: '통화 기록이 추가되었습니다.' })
    }
  } catch (error) {
    toast({ title: '오류', description: '통화 기록 추가에 실패했습니다.', variant: 'destructive' })
  }
}

// UI (간소화된 통화기록 입력)
<Card>
  <CardHeader>
    <CardTitle>통화 기록</CardTitle>
  </CardHeader>
  <CardContent>
    <div className="space-y-4">
      {/* 빠른 메모 입력 */}
      <div className="space-y-2">
        <Textarea
          placeholder="통화 내용을 입력하세요..."
          value={newCallLog.content}
          onChange={(e) => setNewCallLog({ ...newCallLog, content: e.target.value })}
          rows={3}
        />
        <Input
          placeholder="비고 (선택사항)"
          value={newCallLog.note}
          onChange={(e) => setNewCallLog({ ...newCallLog, note: e.target.value })}
        />
        <Button onClick={handleAddCallLog} disabled={!newCallLog.content}>
          통화 기록 저장
        </Button>
      </div>

      {/* 통화 기록 목록 */}
      <div className="space-y-3">
        {customer.callLogs && customer.callLogs.map((log) => (
          <div key={log.id} className="border-l-4 border-blue-500 pl-4 py-2">
            <div className="flex items-center justify-between mb-1">
              <span className="text-sm font-medium">{log.user.name}</span>
              <span className="text-xs text-gray-500">
                {format(new Date(log.createdAt), 'yyyy.MM.dd HH:mm', { locale: ko })}
              </span>
            </div>
            <p className="text-sm">{log.content}</p>
            {log.note && (
              <p className="text-xs text-gray-600 mt-1">비고: {log.note}</p>
            )}
          </div>
        ))}
      </div>
    </div>
  </CardContent>
</Card>
```

새 고객 정보 표시 섹션 추가:

```typescript
{/* 개인 정보 섹션 */}
<Card>
  <CardHeader>
    <CardTitle>개인 정보</CardTitle>
  </CardHeader>
  <CardContent className="grid grid-cols-2 gap-4">
    <div>
      <Label className="text-gray-600">성별</Label>
      <p>{customer.gender === 'MALE' ? '남' : customer.gender === 'FEMALE' ? '여' : '-'}</p>
    </div>
    <div>
      <Label className="text-gray-600">나이대</Label>
      <p>
        {customer.ageRange === 'TWENTIES' ? '20대' :
         customer.ageRange === 'THIRTIES' ? '30대' :
         customer.ageRange === 'FORTIES' ? '40대' :
         customer.ageRange === 'FIFTIES' ? '50대' :
         customer.ageRange === 'SIXTIES_PLUS' ? '60대 이상' : '-'}
      </p>
    </div>
    <div>
      <Label className="text-gray-600">거주지역</Label>
      <p>{customer.residenceArea || '-'}</p>
    </div>
    <div>
      <Label className="text-gray-600">가족관계</Label>
      <p>{customer.familyRelation || '-'}</p>
    </div>
    <div>
      <Label className="text-gray-600">직업</Label>
      <p>{customer.occupation || '-'}</p>
    </div>
    <div>
      <Label className="text-gray-600">분류</Label>
      <p>
        {customer.source === 'AD' ? '광고' :
         customer.source === 'TM' ? 'TM' :
         customer.source === 'FIELD' ? '필드' :
         customer.source === 'REFERRAL' ? '소개' : '-'}
      </p>
    </div>
  </CardContent>
</Card>

{/* 영업 정보 섹션 */}
<Card>
  <CardHeader>
    <CardTitle>영업 정보</CardTitle>
  </CardHeader>
  <CardContent className="space-y-4">
    <div>
      <Label className="text-gray-600">투자성향</Label>
      <div className="flex gap-2 mt-1">
        {customer.investmentStyle && JSON.parse(customer.investmentStyle).timeProfit && (
          <Badge>시세차익</Badge>
        )}
        {customer.investmentStyle && JSON.parse(customer.investmentStyle).monthlyIncome && (
          <Badge>월수익</Badge>
        )}
        {customer.investmentStyle && JSON.parse(customer.investmentStyle).residence && (
          <Badge>실거주</Badge>
        )}
        {!customer.investmentStyle && '-'}
      </div>
    </div>
    <div>
      <Label className="text-gray-600">예상투자금액 (계약금 기준)</Label>
      <p>{customer.expectedBudget ? `${customer.expectedBudget.toLocaleString()}만원` : '-'}</p>
    </div>
    <div>
      <Label className="text-gray-600">보유현황</Label>
      <div className="flex gap-2 mt-1">
        {customer.ownedProperties && JSON.parse(customer.ownedProperties).apt && (
          <Badge variant="outline">APT</Badge>
        )}
        {customer.ownedProperties && JSON.parse(customer.ownedProperties).officetel && (
          <Badge variant="outline">오피스텔</Badge>
        )}
        {customer.ownedProperties && JSON.parse(customer.ownedProperties).commercial && (
          <Badge variant="outline">상가</Badge>
        )}
        {customer.ownedProperties && JSON.parse(customer.ownedProperties).building && (
          <Badge variant="outline">건물</Badge>
        )}
        {!customer.ownedProperties && '-'}
      </div>
    </div>
    <div>
      <Label className="text-gray-600">최근 방문 모델하우스</Label>
      <p>{customer.recentVisitedMH || '-'}</p>
    </div>
  </CardContent>
</Card>
```

---

### Phase 5: 테스트 및 배포 (30분)

#### 5.1 개발 서버 재시작
```bash
npm run dev
```

#### 5.2 테스트 항목

**✅ 기존 데이터 확인:**
- [ ] 기존 50건 고객 데이터가 그대로 있는지
- [ ] 기존 고객 상세 페이지가 에러 없이 열리는지

**✅ 새 고객 등록:**
- [ ] 모든 새 필드가 입력 가능한지
- [ ] 성별, 나이대, 분류 선택 가능한지
- [ ] 투자성향, 보유현황 체크박스 작동하는지
- [ ] 등록 후 상세 페이지에서 정보가 올바르게 표시되는지

**✅ 통화 기록:**
- [ ] 간소화된 통화 기록 입력 폼이 작동하는지
- [ ] 통화 내용만 입력해도 저장 가능한지
- [ ] 비고는 선택사항으로 작동하는지

#### 5.3 Git 커밋 및 푸시
```bash
# 변경사항 확인
git status

# 모든 변경사항 추가
git add -A

# 커밋
git commit -m "feat: 온시아 고객관리카드 시스템 구현

- Customer 모델에 개인정보 필드 추가 (gender, ageRange, residenceArea, familyRelation, occupation)
- Customer 모델에 영업정보 필드 추가 (source, investmentStyle, expectedBudget, ownedProperties, recentVisitedMH)
- Enum 타입 추가 (Gender, AgeRange, CustomerSource)
- CallLog 모델 간소화 (content, note만 유지)
- Validation 스키마 업데이트
- UI 재설계 (관리카드 형태)
- 통화기록 간소화 (빠른 메모 입력)"

# GitHub 푸시
git push origin wsl
```

---

## 🐛 문제 해결

### 문제 1: Prisma generate 실패 (EPERM)
```bash
# 해결: 모든 node 프로세스 종료
taskkill /F /IM node.exe

# 캐시 정리
rm -rf node_modules/.prisma
rm -rf node_modules/@prisma

# 다시 생성
npx prisma generate
```

### 문제 2: 마이그레이션 실패
```bash
# 마이그레이션 초기화 (주의: 개발 환경에서만!)
npx prisma migrate reset

# 새로 마이그레이션
npx prisma migrate dev --name init
```

### 문제 3: 타입 에러
```bash
# Prisma Client 재생성
npx prisma generate

# TypeScript 서버 재시작 (VSCode)
# Ctrl+Shift+P → "TypeScript: Restart TS Server"
```

---

## 📝 작업 순서 요약

```bash
# 1. 서버 종료
taskkill /F /IM node.exe

# 2. Prisma Client 생성
npx prisma generate

# 3. 마이그레이션
npx prisma migrate dev --name add_customer_management_card_fields

# 4. 코드 수정 (위 가이드 참고)
# - lib/validations/customer.ts
# - lib/validations/call-log.ts (새 파일)
# - app/api/call-logs/route.ts
# - app/dashboard/customers/new/page.tsx
# - app/dashboard/customers/[id]/page.tsx

# 5. 개발 서버 시작
npm run dev

# 6. 테스트
# - http://localhost:3007
# - 기존 데이터 확인
# - 새 고객 등록
# - 통화 기록 추가

# 7. Git 커밋 & 푸시
git add -A
git commit -m "feat: 온시아 고객관리카드 시스템 구현"
git push origin wsl
```

---

## ⏱️ 예상 소요 시간

- Phase 1 (DB 마이그레이션): **10분**
- Phase 2 (Validation): **20분**
- Phase 3 (API): **30분**
- Phase 4 (UI): **60-90분**
- Phase 5 (테스트 & 배포): **30분**

**총 예상 시간: 2.5 - 3시간**

---

## 📞 도움이 필요하면

작업 중 막히는 부분이 있으면 어디까지 진행했는지 알려주세요!
